---
title: "STAA 566 HW2"
author: "Ryan Miller"
output: html_document
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
---
The data for this assignment was retrieved from the [Gravitational Wave Open Science
Center](https://www.gw-openscience.org/). I chose this data because it is in
HDF5 format, which I've never used in R before so I had to learn something new (in
addition to the interactive plots!). The code will automatically download the data from
the website, unless a local file path is provided to it.

Working with the data does require the use of the `hdf5r` [package](https://cran.r-project.org/web/packages/hdf5r/index.html), which can be
installed via the R terminal.

The data is of the first observed gravitational wave which took place in September
2015 and was produced by the merging of two black holes.
Data is shown from each of the two detectors `L1` (Livingston) and `H1` (Hanford). More
information can be found
[here](https://www.gw-openscience.org/events/GW150914/#:~:text=The%20event%20occurred%20at%20GPS,Hanford%20and%20LIGO%20Livingston%20observatories.).
This event is known as `GW150914`, which you will see in the plot titles and axes.

You will notice in the plots that the signal is currently indistinguishable from the
noise. The data needs to be processed in order for the signal to become clear, and it
turned out that I will need more time to implement this. My plan is to finish the signal
processing and include it in the shiny project. In that way the hope is that it will be
easy to compare the raw signal from the final product in an interactive way.

```{r, echo = FALSE, message = FALSE}
rm( list = ls() )

## Load required libraries
library(   hdf5r   )
library(  plotly   )
library( tidyverse )
library(  viridis  )
```

```{r, echo = FALSE, results = 'hide'}

#########################################################################################
## Get the data
#########################################################################################
## Caution: Downloading data takes may take some time. Recommend that you only do this
## once. Repeated downloading can also create a lot of temporary files
#########################################################################################
## Get strain data from L1 detector
l1.file.loc <- '~/Downloads/L-L1_LOSC_16_V1-1126256640-4096.hdf5'
if( file.exists( l1.file.loc ) )
{
    print( 'Skipping L1 file download.' )
    l1.temp.5    <- hdf5r::H5File$new( l1.file.loc, mode = 'r+' )
} else
{
    l1.file.loc  <- 'https://www.gw-openscience.org/archive/data/O1_16KHZ/1126170624/L-L1_LOSC_16_V1-1126256640-4096.hdf5'
    l1.temp.file <- tempfile( fileext = '.hdf5' )
    download.file( l1.file.loc, l1.temp.file )
    l1.temp.5    <- hdf5r::H5File$new( l1.temp.file, mode = 'r+' )
}

## Get strain data from H1 detector
h1.file.loc  <- '~/Downloads/H-H1_LOSC_16_V1-1126256640-4096.hdf5'
if( file.exists( h1.file.loc ) )
{
    print( 'Skipping H1 file download.' )
    h1.temp.5    <- hdf5r::H5File$new( h1.file.loc, mode = 'r+' )
} else
{
    h1.file.loc  <- 'https://www.gw-openscience.org/archive/data/O1_16KHZ/1126170624/H-H1_LOSC_16_V1-1126256640-4096.hdf5'
    h1.temp.file <- tempfile( fileext = '.hdf5' )
    download.file( h1.file.loc, h1.temp.file )
    h1.temp.5    <- hdf5r::H5File$new( h1.temp.file, mode = 'r+' )
}

## Get numeric relativity template (will be used in future assignments)
if( FALSE )
{
    temp.file <- tempfile( fileext = '.txt' )
    download.file( 'https://losc.ligo.org/s/events/GW150914/GW150914_4_NR_waveform.txt',
                  temp.file )
    nrel <- read_table( temp.file, col_names = FALSE )
}
```
```{r, echo = FALSE, resutls = 'hide'}

## Process some L1 data
l1.strain   <- l1.temp.5[['strain/Strain']]
l1.utcstart <- l1.temp.5[['meta/UTCstart']]
l1.gpsstart <- l1.temp.5[['meta/GPSstart']]
l1.duration <- l1.temp.5[['meta/Duration']]

## Process some H1 data
h1.strain   <- h1.temp.5[['strain/Strain']]
h1.utcstart <- h1.temp.5[['meta/UTCstart']]
h1.gpsstart <- h1.temp.5[['meta/GPSstart']]
h1.duration <- h1.temp.5[['meta/Duration']]
```
```{r, echo = FALSE, results = 'hide'}

## Learn data structure and some other important features
h5attr_names( l1.strain )
# [1] "Npoints"  "Xunits"   "Xlabel"   "Xspacing" "Xstart"   "Yunits"   "Ylabel"

h5attr( l1.strain, "Npoints" )
# [1] 67108864
h5attr( l1.strain, "Xunits" )
# [1] "second"
h5attr( l1.strain, "Xlabel" )
# [1] "GPS time"
h5attr( l1.strain, "Xspacing" )
# [1] 6.103516e-05
h5attr( l1.strain, "Xstart" )
# [1] 1126256640
h5attr( l1.strain, "Yunits" )
# [1] ""
h5attr( l1.strain, "Ylabel" )
# [1] "Strain"

## When do measurements start?
l1.utcstart[]
# [1] "2015-09-14T09:03:43"
l1.gpsstart[]
# [1] 1126256640
l1.duration[]
# [1] 4096

h1.utcstart[]
# [1] "2015-09-14T09:03:43"
h1.gpsstart[]
# [1] 1126256640
h1.duration[]
# [1] 4096
## Same time stamp on data, only need one from here on out

dt   <- h5attr( l1.strain, 'Xspacing' )
time <- seq( from = l1.gpsstart[], to = l1.gpsstart[] + l1.duration[], by = dt )

## Detection occurred at T09:50:45 and lasted "over 0.2 seconds",
# So need to move 47 minutes and 2 seconds
event <- ( 47 * 60 + 2) / dt
off   <- 5
sIdx  <- event - off / dt
eIdx  <- event + off / dt

## Data for plotting (RAW)
y.l1 <- l1.strain[ sIdx:eIdx ]
y.h1 <- h1.strain[ sIdx:eIdx ]
x    <- time[ event ] - time[ sIdx:eIdx ]
```

```{r, echo = FALSE, results = 'hide'}

## Set up the plotly functions
pd.raw <- data.frame( L1 = y.l1, H1 = y.h1, Time = x )
h.raw <- plot_ly( pd.raw, x = ~Time ) %>%
    add_lines( y = ~L1, name = 'L1' ) %>%
    add_lines( y = ~H1, name = 'H1' ) %>% rangeslider() %>% layout( hovermode = 'x' ) %>%
    layout( title = 'Raw LIGO Strain Near GW150914',
           xaxis = list( title = 'Time (s) since GW150914' ),
           yaxis = list( title = 'Strain' ) )
```
\
\
\
```{r, echo = FALSE, fig.align = 'center'}
h.raw
```
\
\
\
```{r, echo = FALSE}

#########################################################################################
## Close all HDF5 stuff
#########################################################################################
l1.temp.5$close_all()
h1.temp.5$close_all()
```

## Code

```{r getlabs, results = 'hide', include = FALSE}
## Get all the labels
appLabs <- knitr::all_labels()
appLabs <- setdiff( appLabs, c('getlabs', appLabs[grep("^hide", appLabs)]) )
```

```{r show-code, ref.label = appLabs, echo = TRUE, eval = FALSE}
```

## References
A guide to LIGO-Virgo detector noise and extraction of transient gravitational-wave
signals; https://arxiv.org/pdf/1908.11170.pdf

Signal Processing with GW150914 Open Data;
https://www.gw-openscience.org/GW150914data/GW150914_tutorial.html
